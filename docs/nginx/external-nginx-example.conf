# External Nginx Configuration Example
# 
# This is an example configuration for an external Nginx server running on the host
# (outside of Docker containers). Use this when you want to:
# - Add SSL/HTTPS support via Let's Encrypt (Certbot)
# - Use your own domain name
# - Have more control over SSL/TLS settings
# - Proxy to the internal nginx container
#
# This file should be placed in your external Nginx configuration directory
# (typically /etc/nginx/sites-available/ on Linux)
#
# Instructions:
# 1. Replace 'example.com' with your actual domain name
# 2. Replace 'localhost:63345' with your server IP and the port where internal nginx is exposed
#    (check docker-compose.override.yml for nginx port mapping)
# 3. Configure SSL certificates (e.g., using Certbot: certbot --nginx -d example.com)
# 4. Enable the site: ln -s /etc/nginx/sites-available/example.com /etc/nginx/sites-enabled/
# 5. Test and reload: nginx -t && systemctl reload nginx
#
# Note: This configuration is optimized for streaming and large requests
# (Tier 2 rate limits: RPM 1,000, ITPM up to 500k, OTPM up to 50k)

# HTTP server - redirect to HTTPS
server {
    if ($host = example.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    server_name example.com;
    listen [::]:80;
    listen 80;
    return 404; # managed by Certbot
}

# HTTPS server - main configuration
server {
    server_name example.com;
    
    # SSL configuration (managed by Certbot)
    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    # Increase max body size for large requests - optimized for Tier 2 rate limits
    # Tier 2: RPM 1,000, ITPM up to 500k, OTPM up to 50k (per https://platform.claude.com/docs/en/api/rate-limits#tier-2)
    client_max_body_size 100M;
    
    # Client body buffering - optimized for Tier 2 rate limits
    # Large buffer prevents nginx from writing to temp files for requests up to buffer size
    # This avoids hanging worker processes when reading large request bodies
    # Set to 3M for Tier 2: handles large context requests (200k+ tokens, ~800KB+ JSON payloads)
    # Balanced for memory safety while supporting Tier 2 workloads
    client_body_buffer_size 3M;
    client_body_timeout 300s;
    client_header_timeout 300s;
    
    # Increased timeouts to prevent upstream timeouts
    # Default timeouts for all requests
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    send_timeout 300s;
    
    # API endpoints - disable buffering for streaming
    location ~ ^/api/litellm/v1/ {
        proxy_pass http://localhost:63345;
        
        # Include standard proxy parameters
        include proxy_params;
        
        # HTTP/1.1 for better streaming support
        proxy_http_version 1.1;
        
        # WebSocket and streaming support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Use large buffer to avoid temp files and prevent hanging requests
        # Large buffer allows nginx to read request body in memory without writing to temp files
        # Set to 3M for Tier 2: handles large context requests (200k+ tokens, ~800KB+ JSON payloads)
        # Balanced for memory safety while supporting Tier 2 workloads
        client_body_buffer_size 3M;
        client_body_timeout 300s;
        
        # Disable client body buffering for large API requests (if needed)
        # client_body_buffer_size 0;  # Uncomment if still having issues
        
        # Disable proxy buffering for streaming responses
        proxy_buffering off;
        proxy_cache off;
        
        # Enable chunked transfer encoding for streaming
        chunked_transfer_encoding on;
        
        # Long timeouts for API requests
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
    
    # Root path and other locations
    location / {
        proxy_pass http://localhost:63345;
        
        # Include standard proxy parameters (sets Host, X-Real-IP, X-Forwarded-For, Connection, etc.)
        include proxy_params;
        
        # HTTP/1.1 for better streaming support
        proxy_http_version 1.1;
        
        # WebSocket support (only if Upgrade header is present)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Long timeouts for all requests (prevent upstream timeout errors)
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
}


