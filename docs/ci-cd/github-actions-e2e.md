# E2E Tests on GitHub Actions

## GitHub Actions Runner Resources

### Публичные репозитории (бесплатно)
- **CPU**: 4 cores
- **RAM**: 16 GB
- **Disk**: 14 GB (доступно для использования)
- **Время выполнения**: До 6 часов на задание
- **Лимит минут**: Неограниченно (бесплатно)

### Приватные репозитории
- **CPU**: 2 cores
- **RAM**: 7 GB
- **Disk**: 14 GB (доступно для использования)
- **Время выполнения**: До 6 часов на задание
- **Лимит минут**: Ограничен планом (2000 минут/месяц для бесплатного плана)

**Коэффициенты потребления минут:**
- Linux: 1x
- Windows: 2x
- macOS: 10x

## Требования к ресурсам для E2E тестов

### Текущие профили ресурсов

| Profile | RAM | CPU | Workers | Usage (idle) | Usage (with buffer) |
|---------|-----|-----|---------|--------------|---------------------|
| **Small VPS** | 2GB | 2 | 1 | ~2.3GB | ~2.0-2.5GB |
| **Medium VPS** | 4GB | 4 | 2 | ~3.0GB | ~3.3GB |
| **Large VPS** | 8GB+ | 8+ | 6 | ~5.1GB | ~5.7GB |

**Примечание**: Использование памяти включает:
- Контейнеры (LiteLLM, Open WebUI, PostgreSQL, Nginx)
- Системные накладные расходы (~1.2GB для типичного Linux)
- Буферы для активных запросов

### Анализ совместимости с GitHub Actions

#### ✅ Публичные репозитории (16 GB RAM)
- **Small VPS** (1 worker, ~2.0-2.5GB): ✅ **Подходит** - много места
- **Medium VPS** (2 workers, ~3.3GB): ✅ **Подходит** - достаточно места
- **Large VPS** (6 workers, ~5.7GB): ✅ **Подходит** - достаточно места

#### ⚠️ Приватные репозитории (7 GB RAM)
- **Small VPS** (1 worker, ~2.0-2.5GB): ✅ **Подходит** - достаточно места
- **Medium VPS** (2 workers, ~3.3GB): ⚠️ **Возможно** - tight, но должно работать
- **Large VPS** (6 workers, ~5.7GB): ❌ **Не подходит** - превышает доступную RAM

### Рекомендации для GitHub Actions

#### Для всех репозиториев
- ✅ **E2E тесты используют Small VPS по умолчанию** (1 worker, ~2.0-2.5GB)
- ✅ Подходит для публичных репозиториев (16GB RAM) - много места
- ✅ Подходит для приватных репозиториев (7GB RAM) - достаточно места
- ✅ Быстрое выполнение тестов
- ✅ Минимальное потребление ресурсов

#### Переопределение профиля (опционально)
- Для публичных репозиториев можно использовать Medium/Large VPS через `E2E_RESOURCE_PROFILE`
- Для приватных репозиториев рекомендуется оставить Small VPS (по умолчанию)

## Настройка E2E тестов для GitHub Actions

### Использование Small VPS для E2E тестов

E2E тесты **всегда используют Small VPS по умолчанию** для:
- ✅ Быстрого выполнения тестов
- ✅ Минимального использования ресурсов (1 worker, ~2.0-2.5GB RAM)
- ✅ Совместимости с CI/CD окружениями (GitHub Actions, etc.)

### Текущее поведение

По умолчанию E2E тесты используют **Small VPS** (1 worker, ~2.0-2.5GB), что:
- ✅ Подходит для публичных репозиториев (16GB RAM)
- ✅ Подходит для приватных репозиториев (7GB RAM)
- ✅ Быстрое выполнение тестов
- ✅ Минимальное потребление ресурсов

### Переопределение профиля

Если нужно использовать другой профиль для тестов, можно указать через env var:

```bash
# Использовать Medium VPS (2 workers, ~3.3GB)
E2E_RESOURCE_PROFILE=medium pytest tests/e2e/ -v -m e2e

# Использовать Large VPS (6 workers, ~5.7GB) - только для публичных репозиториев
E2E_RESOURCE_PROFILE=large pytest tests/e2e/ -v -m e2e
```

## Оценка времени выполнения

### Ожидаемое время на GitHub Actions

- **Setup**: ~30-60 секунд
- **Запуск контейнеров**: ~2-5 минут (зависит от загрузки образов)
- **Health checks**: ~1-2 минуты
- **API тесты**: ~1-2 минуты
- **Остановка контейнеров**: ~30 секунд

**Итого**: ~5-10 минут на полный цикл E2E тестов

### Оптимизация для CI/CD

1. **Кэширование Docker образов** (если возможно)
2. **Параллельный запуск тестов** (если не конфликтуют)
3. **Использование Small VPS** для минимизации времени запуска

## Проблемы и ограничения

### Потенциальные проблемы

1. **Недостаток RAM на приватных раннерах**:
   - Решение: Использовать Small VPS (1 worker)
   
2. **Медленная загрузка Docker образов**:
   - Решение: Кэширование образов (если возможно)
   
3. **Таймауты при запуске контейнеров**:
   - Решение: Увеличить timeout или оптимизировать health checks

4. **Конфликты портов** (если несколько тестов параллельно):
   - Решение: Использовать random high ports (уже реализовано)

### Рекомендации

1. ✅ **Использовать Small VPS для CI/CD** (минимизация ресурсов)
2. ✅ **Настроить кэширование Docker образов** (ускорение)
3. ✅ **Мониторить использование ресурсов** в GitHub Actions
4. ✅ **Использовать публичные раннеры** если возможно (больше ресурсов)

## Пример конфигурации для GitHub Actions

```yaml
name: E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Install dependencies
        run: |
          pip install -r requirements-dev.txt
      
      - name: Run E2E tests
        env:
          NON_INTERACTIVE: 1
          # Small VPS используется по умолчанию (не нужно указывать явно)
          # Для переопределения: E2E_RESOURCE_PROFILE=medium
        run: |
          pytest tests/e2e/ -v -m e2e
```

## См. также

- [System Requirements](../system-requirements.md) - детальные требования к ресурсам
- [Configuration](../configuration.md#resource-profiles) - описание профилей ресурсов
- [E2E Tests README](../../tests/e2e/README.md) - документация по E2E тестам

